# toascii
Unix filter. Formerly a D CLI wrapper of
[stringex.unidecode](https://code.dlang.org/packages/stringex), but rewritten
in OCaml after I tried to make the D version *slightly* better and encountered
egregious limits in Phobos's support for the Unix API.

D is still present in tools/dump\_stringex.d which is a script, using dub, to
produce an OCaml-formatted version of the replacement table used by that same D
library.

D is not needed to build or use this code as the output of that script is
checked in and the dune rule is using
[mode fallback](https://dune.readthedocs.io/en/stable/reference/dune/rule.html#modes).

# usage
toascii is a unix filter, so

```sh
$ toascii file-containing-Unicode
# the file is now definitely poorly named

$ cat file | toascii

$ toascii
(paste unicode, get ascii)
```

# build
```sh
dune build --release
```

# install
```sh
dune install
```

# benchmark
d version from 2102cf1, built with ldc2 and `dub -brelease`, 30x applications
to the same file (a copy of the toascii binary generated by this version):
```
Real time      : 4 s 49 ms
User time      : 4.0162 s
System time    : 0.2104 s
Time           : 4 s 226 ms (140.885 ms/per)
Max RSS        : 8.4 MB
Page reclaims  : 20042
Page faults    : 0
Block inputs   : 0
Block outputs  : 73920
vol ctx switches   : 37276
invol ctx switches : 99
```
ocaml version from c61a585, built with `dune build --release`, same run and file:
```
Real time      : 230.0 ms
User time      : 0.0893 s
System time    : 0.0759 s
Time           : 165.2 ms (5.507 ms/per)
Max RSS        : 6.5 MB
Page reclaims  : 19521
Page faults    : 0
Block inputs   : 696
Block outputs  : 77040
vol ctx switches   : 999
invol ctx switches : 16
```
or in more detail:
```
Benchmark 1 (37 runs): d
  measurement          mean ± σ            min … max           outliers         delta
  wall_time           137ms ± 7.71ms     131ms …  174ms          3 ( 8%)        0%
  peak_rss           8.57MB ±  109KB    8.38MB … 8.78MB          0 ( 0%)        0%
  cpu_cycles          614M  ± 36.6M      589M  …  796M           3 ( 8%)        0%
  instructions       1.94G  ± 70.7K     1.94G  … 1.94G           0 ( 0%)        0%
  cache_references   6.12M  ± 3.41M     5.14M  … 24.0M           4 (11%)        0%
  cache_misses        514K  ± 22.3K      481K  …  582K           1 ( 3%)        0%
  branch_misses       129K  ± 3.22K      124K  …  137K           0 ( 0%)        0%
Benchmark 2 (692 runs): ocaml
  measurement          mean ± σ            min … max           outliers         delta
  wall_time          7.19ms ±  363us    6.21ms … 8.92ms         15 ( 2%)        ⚡- 94.7% ±  0.4%
  peak_rss           6.51MB ± 65.0KB    6.28MB … 6.55MB          0 ( 0%)        ⚡- 24.1% ±  0.3%
  cpu_cycles         11.9M  ±  409K     11.4M  … 14.4M          38 ( 5%)        ⚡- 98.1% ±  0.4%
  instructions       49.4M  ± 28.5      49.4M  … 49.4M          85 (12%)        ⚡- 97.5% ±  0.0%
  cache_references    235K  ± 7.68K      221K  …  281K          17 ( 2%)        ⚡- 96.2% ±  4.1%
  cache_misses       21.9K  ± 1.16K     19.9K  … 28.4K          34 ( 5%)        ⚡- 95.7% ±  0.3%
  branch_misses      19.5K  ±  467      18.4K  … 24.1K          15 ( 2%)        ⚡- 84.8% ±  0.2%
```
OCaml's buffered I/O uses a buffer 16x that of D's, that's not enough to explain the difference.
```
OCaml:
  38.23%  main.exe  main.exe              [.] Toascii.Unidecode.anon_fn[unidecode.ml:24,30--59]_126
  14.18%  main.exe  main.exe              [.] caml_input_scan_line
   8.11%  main.exe  main.exe              [.] Stdlib.Bytes.loop_1292
   6.37%  main.exe  libc.so.6             [.] __GI___pthread_mutex_unlock_usercnt
   6.31%  main.exe  libc.so.6             [.] __memmove_avx512_unaligned_erms
   6.27%  main.exe  main.exe              [.] caml_create_bytes
   5.98%  main.exe  main.exe              [.] caml_c_call
   5.77%  main.exe  main.exe              [.] caml_memprof_sample_block
   2.80%  main.exe  [unknown]             [k] 0xffffffffba037d85
   2.60%  main.exe  main.exe              [.] fill_hashtable.constprop.0
   2.47%  main.exe  ld-linux-x86-64.so.2  [.] do_lookup_x

d:
  28.24%  toascii  libdruntime-ldc-shared.so.110.0  [.] _d_array_slice_copy
  20.97%  toascii  libdruntime-ldc-shared.so.110.0  [.] _D4core8internal8spinlock8SpinLock4lockMOFNbNiN
  11.82%  toascii  libdruntime-ldc-shared.so.110.0  [.] _DThn16_4core8internal2gc4impl12conservativeQw1
   8.62%  toascii  libdruntime-ldc-shared.so.110.0  [.] _D4core8internal2gc4impl12conservativeQw3Gcx10s
   5.63%  toascii  toascii                          [.] _D3std6format5write__T11formatValueTSQBj5array_
   4.74%  toascii  libdruntime-ldc-shared.so.110.0  [.] _D4core8internal4util5array27enforceRawArraysCo
   3.12%  toascii  libdruntime-ldc-shared.so.110.0  [.] _D4core8internal2gc4impl12conservativeQw14Conse
   2.94%  toascii  libc.so.6                        [.] __memset_avx512_unaligned_erms
   1.76%  toascii  toascii                          [.] _D3std5array__T8AppenderTAyaZQo13ensureAddableM
   1.57%  toascii  toascii                          [.] _D3std6format8internal5write__T12writeAlignedTS
   1.54%  toascii  libdruntime-ldc-shared.so.110.0  [.] _D4core8internal2gc4bits6GCBits5clearMFNaNbNiNl
   1.31%  toascii  libdruntime-ldc-shared.so.110.0  [.] gc_qalloc
```
